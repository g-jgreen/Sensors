{
    "name": "parkingGent",
    "version": "0.0.1",
    "type": "sensor",
    "script": "var response = { \"Parkings11\" : {\n  \"parkings\": [\n    {\n      \"timestamp\": 1430400059757,\n      \"name\": \"P01\",\n      \"description\": \"Vrijdagmarkt\",\n      \"address\": \"Vrijdagmarkt 1,<br>9000 Gent\",\n      \"contactInfo\": \"Tel.: 09 266 29 00 <br> (permanentie)<br> Tel.: 09 266 29 01 <br> (tijdens kantooruren)\",\n      \"openingHours\": \"24/24 open\",\n      \"open\": true,\n      \"full\": false,\n      \"suggestedRGB\": \"#00ff00\",\n      \"totalCapacity\": 642,\n      \"availableCapacity\": \"68\",\n      \"latitude\": 51.057,\n      \"longitude\": 3.726,\n      \"covered\": true\n    },\n    {\n      \"timestamp\": 1430400059757,\n      \"name\": \"P07\",\n      \"description\": \"Sint-Michiels\",\n      \"address\": \"Sint-Michielsplein 8,<br>9000 Gent\",\n      \"contactInfo\": \"Tel.: 09 266 29 20\",\n      \"openingHours\": \"24/24 open\",\n      \"open\": true,\n      \"full\": false,\n      \"suggestedRGB\": \"#00ff00\",\n      \"totalCapacity\": 450,\n      \"availableCapacity\": \"140\",\n      \"latitude\": 51.053,\n      \"longitude\": 3.719,\n      \"covered\": true,\n      \"activeRoute\": []\n    },\n    {\n      \"timestamp\": 1430400059757,\n      \"name\": \"P10\",\n      \"description\": \"Sint-Pietersplein\",\n      \"address\": \"Sint-Pietersplein 65,<br>9000 Gent\",\n      \"contactInfo\": \"Tel.: 09 266 29 60\",\n      \"openingHours\": \"24/24 open\",\n      \"open\": true,\n      \"full\": false,\n      \"suggestedRGB\": \"#00ff00\",\n      \"totalCapacity\": 708,\n      \"availableCapacity\": \"377\",\n      \"latitude\": 51.042,\n      \"longitude\": 3.726,\n      \"covered\": true,\n      \"activeRoute\": []\n    },\n    {\n      \"timestamp\": 1430400059757,\n      \"name\": \"P04\",\n      \"description\": \"Savaanstraat\",\n      \"address\": \"Savaanstraat 13,<br>9000 Gent\",\n      \"contactInfo\": \"Tel.: 09 266 29 40\",\n      \"openingHours\": \"24/24 open\",\n      \"open\": true,\n      \"full\": false,\n      \"suggestedRGB\": \"#00ff00\",\n      \"totalCapacity\": 540,\n      \"availableCapacity\": \"257\",\n      \"latitude\": 51.0486,\n      \"longitude\": 3.7222,\n      \"covered\": true,\n      \"activeRoute\": []\n    },\n    {\n      \"timestamp\": 1430400059757,\n      \"name\": \"P02\",\n      \"description\": \"Reep\",\n      \"address\": \"Seminariestraat 9,<br>9000 Gent\",\n      \"contactInfo\": \"Tel.: 09 266 29 50\",\n      \"openingHours\": \"24/24 open\",\n      \"open\": true,\n      \"full\": false,\n      \"suggestedRGB\": \"#00ff00\",\n      \"totalCapacity\": 470,\n      \"availableCapacity\": \"66\",\n      \"latitude\": 51.052,\n      \"longitude\": 3.731,\n      \"covered\": true,\n      \"activeRoute\": []\n    },\n    {\n      \"timestamp\": 1430400059757,\n      \"name\": \"P08\",\n      \"description\": \"Ramen\",\n      \"address\": \"Ramen 23,<br>9000 Gent\",\n      \"contactInfo\": \"Tel.: 09 266 29 70\",\n      \"openingHours\": \"24/24 open\",\n      \"open\": true,\n      \"full\": false,\n      \"suggestedRGB\": \"#00ff00\",\n      \"totalCapacity\": 266,\n      \"availableCapacity\": \"85\",\n      \"latitude\": 51.056,\n      \"longitude\": 3.716,\n      \"covered\": true,\n      \"activeRoute\": []\n    }\n  ]\n}};\n\n//array of parkings that are full from the previous check\nvar cacheFullParkings = waylayUtil.getCacheData(options, \"fullParkings\") || [];\n\n/*var url =\"http://datatank.gent.be/Mobiliteitsbedrijf/Parkings11.json\";\n    request({\n            \"uri\": url\n        }, function(err, response, body){\n            if (!err && response.statusCode == 200) {\n                var data = JSON.parse(body);\n                //console.log(data);\n                processData(data);\n            } else {\n                console.log(response);\n                send(new Error(response.statusCode));\n            }\n});  */ \n\nvar filterParking = function(parking, listAvailiableParkings, listLowCapacityParkings, cacheFullParkings){\n    return ( __.contains(listAvailiableParkings, parking)  &&  !__.contains(cacheFullParkings, parking) ) || \n               ( __.contains(listAvailiableParkings, parking)  &&  __.contains(cacheFullParkings, parking)  && \n                        !__.contains(listLowCapacityParkings, parking)) ;\n    \n}\n\nvar processData = function(data){\n    var parkings = data.Parkings11.parkings;\n    parkings = __.map(parkings, function(p) {\n        p.availCapPercentage = parseFloat(p.availableCapacity)/parseFloat(p.totalCapacity);\n        return p;\n    });\n    var availableParkings = __.filter(parkings, function(parking) {\n        return (!parking.full && parking.open);\n    });\n    var listAvailiableParkings = __.map(availableParkings, function(p) {return p.description});\n    var listLowCapacityParkings = __.compact(__.map(availableParkings, function(p) {if(p.availCapPercentage < 0.15) return p.description}));\n    var fullParkings = __.filter(parkings, function(parking) {return parking.full && !parking.open;});\n    var listfullParkings = __.map(fullParkings, function(p) {return p.description});\n    \n    var list = __.filter([\"Vrijdagmarkt\", \"Reep\", \"Ramen\" , \"Sint-Michiels\"], function(p) {return filterParking(p);});\n    if(list1.length < 0)\n      list = __.filter([\"Reep\",\"Vrijdagmarkt\", \"Sint-Pietersplein\", \"Savaanstraat\"], function(p) {return filterParking(p);});\n    if(list.length < 0)\n       list = __.filter([\"Savaanstraat\", \"Sint-Pietersplein\", \"Ramen\" , \"Sint-Michiels\"], function(p) {return filterParking(p);});\n    if(list.length < 0)\n       list = __.filter([\"Sint-Michiels\", \"Ramen\", \"Sint-Pietersplein\" , \"Savaanstraat\"], function(p) {return filterParking(p);});\n    if(list.length < 0)\n       list = __.filter([\"Ramen\", \"Sint-Michiels\", \"Sint-Pietersplein\" , \"Savaanstraat\"], function(p) {return filterParking(p);});\n    \n    var parking = \"NONE\";\n    if(list.length > 0)\n        parking = list[0];\n\n    var rawData = { parkings : parkings, \n        fullParkings : listfullParkings, \n        availableParkings: listAvailiableParkings,\n        lowCapacityParkings: listLowCapacityParkings,\n        recommendation: parking\n    };\n    var value ={\n        observedState : listAvailiableParkings.length > 0 ? \"Found\" : \"Not Found\",\n        rawData : rawData\n    }\n   send(null, value);\n};\n\nprocessData(response);",
    "metadata": {
        "author": "",
        "category": "Smart City",
        "description": "Under construction",
        "documentationURL": "http://datatank.gent.be/Mobiliteitsbedrijf/Parkings11.jso",
        "iconURL": "https://raw.githubusercontent.com/waylayio/documentation/master/icons/parking.png",
        "supportedStates": [
            "Found",
            "Not Found"
        ],
        "requiredProperties": [],
        "requiredRawData": [],
        "rawData": [
            {
                "parameter": "parkings",
                "dataType": "Object[]"
            },
            {
                "parameter": "fullParkings",
                "dataType": "String[]"
            },
            {
                "parameter": "availableParkings",
                "dataType": "double"
            },
            {
                "parameter": "lowCapacityParkings",
                "dataType": "double"
            },
            {
                "parameter": "recommendation",
                "dataType": "double"
            }
        ]
    }
}
