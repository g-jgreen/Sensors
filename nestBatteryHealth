{
  "name": "nestBatteryHealth",
  "version": "0.0.6",
  "script": "var username =  options.globalSettings.API_KEY;\nvar password = options.globalSettings.API_PASS;\nvar domain = options.requiredProperties.domain || options.globalSettings.waylay_domain ||\"app.waylay.io\";\nvar dataDomain = options.globalSettings.data_domain || \"https://data.waylay.io/\";\nvar resource = options.requiredProperties.resource || waylayUtil.getResource(options);\n\nvar sendResult = function(param){\n    console.log(\"param=\" + param);\n    var state;\n    switch(param.battery_health) {\n        case \"ok\":\n            state = \"OK\"\n            break;\n        case \"replace\":\n            state = \"Replace\"\n            break;\n        default:\n            send(new Error(\"Invalid value in resource\"));\n    }\n\n    var value = {\n        observedState : state,\n        rawData: {\n            parameter: state\n        }\n    }\n\n    console.log(value)\n    send(null, value);\n}\n\n\ntry {\n    if(domain !== undefined  && username === undefined  || password === undefined){\n        send(new Error(\"missing properites\"))\n    } else {\n        var runtimeParam = waylayUtil.getStreamData(options);\n        if(!_.isEmpty(runtimeParam)){\n            console.log(\"runtime data : \" + runtimeParam);\n            sendResult(runtimeParam);\n        } else{\n            if(domain !== undefined  && username !== undefined && password !== undefined && resource !== undefined)  {\n                var url = dataDomain + \"resources/\"+ resource +\"/current?domain=\"+domain;\n                var options = {\n                    url: url,\n                    method: 'GET',\n                    auth: {\n                        user: username,\n                        password: password\n                    }\n                };\n                request(options, function (error, response, body) {\n                  console.log(\"check the cloud cache\")\n                  if (!error && response.statusCode == 200) {\n                    console.log(body);\n                    var rawData = JSON.parse(body);\n                    sendResult(rawData);\n                    } else {\n                        console.log(response);\n                        send(new Error(\"data not found\"));\n                    }\n                }); \n            } else{\n                 send(new Error(\"Missing properties\"));\n            }\n        }\n    }\n} catch(err){\n    send(new Error(err));   \n}",
  "metadata": {
    "author": "",
    "category": "Nest",
    "description": "Test sensor nest battery health",
    "iconURL": "http://file.answcdn.com/answ-cld/image/upload/v1/tk/brand_image/c7d3fadd/c71c29fef0dd6c56a9b2777906bcf3245960c403.png",
    "supportedStates": [
      "OK",
      "Replace"
    ],
    "requiredProperties": [
      "resource"
    ],
    "requiredRawData": [],
    "rawData": [
      {
        "parameter": "parameter",
        "dataType": "string"
      }
    ]
  }
}
